@using SumyCRM.Areas.Admin.Models
@model PaginationViewModel<Request>
@{
    int itemIndex = (Model.CurrentPage - 1) * Model.PageSize + 1;
    var categories = ViewBag.Categories as List<Category> ?? new List<Category>();
    Guid? selectedCategoryId = ViewBag.SelectedCategoryId as Guid?;
    string dateFrom = ViewBag.DateFrom as string;
    string dateTo = ViewBag.DateTo as string;
    bool areCompleted = ViewBag.AreCompleted;
    var currentPage = Model.CurrentPage;
}
<div class="d-flex justify-content-between align-items-center mb-3">
    @if (!ViewBag.AreCompleted)
    {
        <h2>Активні</h2>
    }
    else
    {
        <h2>Виконані</h2>
    }

    <div class="d-flex align-items-center gap-2">
        <div class="input-group input-group-sm" style="width: 250px;">
            <span class="input-group-text bg-white">
                <i class="fa-solid fa-magnifying-glass"></i>
            </span>
            <input type="text"
                   id="requestSearch"
                   class="form-control"
                   placeholder="Пошук звернення..." />
        </div>
    </div>
    
</div>
<form method="get" class="row g-2 align-items-end mb-3">

    <!-- сохраняем completed и стартовую страницу -->
    <input type="hidden" name="completed" value="@(areCompleted ? "true" : "false")" />
    <input type="hidden" name="page" id="pageInput" value="@currentPage" />

    <div class="col-md-4">
        <label class="form-label form-label-sm">Категорія</label>
        <select name="categoryId" class="form-select form-select-sm">
            <option value="">Всі категорії</option>
            @foreach (var cat in categories)
            {
                var selected = selectedCategoryId.HasValue && selectedCategoryId.Value == cat.Id
                ? "selected"
                : "";
                <option value="@cat.Id"
                        selected="@(selectedCategoryId.HasValue && selectedCategoryId.Value == cat.Id)">
                    @cat.Title
                </option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <label class="form-label form-label-sm">Від дати</label>
        <input type="date"
               name="dateFrom"
               value="@dateFrom"
               class="form-control form-control-sm" />
    </div>

    <div class="col-md-3">
        <label class="form-label form-label-sm">До дати</label>
        <input type="date"
               name="dateTo"
               value="@dateTo"
               class="form-control form-control-sm" />
    </div>

    <div class="col-md-2 d-flex gap-2">
        <button type="submit" class="btn btn-primary btn-sm w-100">
            Застосувати
        </button>
        <a class="btn btn-outline-secondary btn-sm w-100"
           href="@Url.Action("Index", "Requests", new { area = "Admin", page = 1, completed = (bool)ViewBag.AreCompleted })">
            Скинути
        </a>
    </div>
</form>
<div>
    @if (Model.PageItems.Any())
    {
        <div class="table-responsive">
            <table class="table table-bordered table-hover table-sm align-middle compact-table">
                <thead>
                    <tr>
                        <th scope="col">№</th>
                        <th scope="col">Номер звернення</th>
                        <th scope="col">Установа</th>
                        <th scope="col">Ім'я</th>
                        <th scope="col">Номер телефону</th>
                        <th scope="col">Адреса</th>
                        <th scope="col">Категорія</th>
                        <th scope="col">Підкатегорія</th>
                        <th scope="col">Текст</th>
                        <th scope="col">Аудіо</th>
                        <th scope="col">Дата</th>
                        <th scope="col"></th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody id="requestsTableBody">
                    @foreach (var item in Model.PageItems)
                    {
                        <tr>
                            <th scope="row">@itemIndex</th>
                            <td>
                                <label>
                                    <span>@item.RequestNumber</span>
                                </label>
                            </td>
                            <td>
                                <label>
                                    <span>@item.Facility</span>
                                </label>
                            </td>
                            <td>
                                <label>
                                    <span>@item.Name</span>
                                </label>
                            </td>
                            <td>
                                <label>
                                    <span>@item.Caller</span>
                                </label>
                            </td>
                            <td>
                                <label>
                                    <span>@item.Address</span>
                                </label>
                            </td>
                            <td>
                                <label>
                                    <span>@item.Category?.Title</span>
                                </label>
                            </td>
                            <td>
                                <label>
                                    <span>@item.Subcategory</span>
                                </label>
                            </td>
                            <td>
                                <label>
                                    <span>@item.Text</span>
                                </label>
                            </td>
                            <td>
                                <label>
                                    <span>
                                        <audio controls src="@item.NameAudioFilePath"></audio>
                                    </span>
                                </label>

                                <label>
                                    <span>
                                        <audio controls src="@item.AudioFilePath"></audio>
                                    </span>
                                </label>
                            </td>
                            <td>
                                <label>
                                    <span>@item.DateAdded.ToLocalTime().ToString("dd.MM.yyyy HH:mm:ss")</span>
                                </label>
                            </td>


                            <td>
                                <a asp-area="Admin" asp-controller="Requests" asp-action="Show" asp-route-id="@item.Id">
                                    <i class="fa-solid fa-eye fa-lg"></i>
                                </a>
                            </td>
                            <td>

                                    @if (item.IsCompleted)
                                    {
                                        @if (User.IsInRole("admin"))
                                        {
                                            <form style="display: inline-block;" id="form-@item.Id" asp-area="Admin" asp-controller="Requests" asp-action="Delete" method="post" class="d-inline">
                                                <input type="hidden" name="id" value="@item.Id" />
                                                <button type="button" class="btn btn-sm btn-danger" onclick="confirmDelete('@item.Id')">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </form>
                                        }
                                    }
                                    else
                                    {
                                        <form asp-area="Admin" asp-controller="Requests" asp-action="CompleteRequest" method="post">
                                            <input type="hidden" name="id" value="@item.Id" />
                                            <button type="submit" class="btn btn-success">
                                                <i class="fa-solid fa-square-check fa-lg"></i>
                                            </button>
                                        </form>
                                    }
                            </td>

                        </tr>
                        itemIndex += 1;
                    }
                </tbody>
            </table>
        </div>
    }
    <!-- Pagination Controls -->
    <nav id="paginationNav">
        <ul class="pagination">
            @if (Model.TotalPages > 1)
            {
                var completed = (bool)ViewBag.AreCompleted;
                var catId = ViewBag.SelectedCategoryId;
                var df = ViewBag.DateFrom;
                var dt = ViewBag.DateTo;

                if (Model.CurrentPage > 1)
                {
                    <li class="page-item">
                        <a class="page-link"
                           asp-action="Index"
                           asp-route-page="@(Model.CurrentPage - 1)"
                           asp-route-completed="@completed"
                           asp-route-categoryId="@catId"
                           asp-route-dateFrom="@df"
                           asp-route-dateTo="@dt"
                           aria-label="Попередня">
                            <span aria-hidden="true">&laquo;</span>
                            <span class="sr-only">Previous</span>
                        </a>
                    </li>
                }

                @for (var i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(Model.CurrentPage == i ? "active" : "")">
                        <a class="page-link"
                           asp-action="Index"
                           asp-route-page="@i"
                           asp-route-completed="@completed"
                           asp-route-categoryId="@catId"
                           asp-route-dateFrom="@df"
                           asp-route-dateTo="@dt">
                            @i
                        </a>
                    </li>
                }

                if (Model.CurrentPage < Model.TotalPages)
                {
                    <li class="page-item">
                        <a class="page-link"
                           asp-action="Index"
                           asp-route-page="@(Model.CurrentPage + 1)"
                           asp-route-completed="@completed"
                           asp-route-categoryId="@catId"
                           asp-route-dateFrom="@df"
                           asp-route-dateTo="@dt"
                           aria-label="Наступна">
                            <span aria-hidden="true">&raquo;</span>
                            <span class="sr-only">Next</span>
                        </a>
                    </li>
                }
            }
        </ul>
    </nav>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationLabel">Підтвердження видалення</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Ви впевнені, що хочете видалити цю заявку?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Видалити</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        let formToSubmit = null;

        function confirmDelete(formId) {
            formToSubmit = document.getElementById(`form-${formId}`);
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
            deleteModal.show();
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
            if (formToSubmit) formToSubmit.submit();
        });

        // ===== LIVE LOAD + AUTOREFRESH ДЛЯ ЗАЯВОК =====
        (function () {
            const searchInput   = document.getElementById('requestSearch');
            const tableBody     = document.getElementById('requestsTableBody');
            const paginationNav = document.getElementById('paginationNav');
            const filtersForm   = document.getElementById('filtersForm');
            const pageInput     = document.getElementById('pageInput');

            if (!tableBody) return;

            const isAdmin = @User.IsInRole("admin").ToString().ToLower();       // true/false
            const initialCompleted = @areCompleted.ToString().ToLower();        // true/false
            const initialPage = @currentPage;                                   // int

            const state = {
                page: initialPage,
                completed: initialCompleted,
                term: ''
            };

            let typingTimer = null;
            let lastController = null;

            function getFilters() {
                const categoryId = document.querySelector('select[name="categoryId"]')?.value || '';
                const dateFrom   = document.querySelector('input[name="dateFrom"]')?.value || '';
                const dateTo     = document.querySelector('input[name="dateTo"]')?.value || '';
                const isCompleted  = document.querySelector('input[name="isCompleted"]')?.value || state.completed;

                return { categoryId, dateFrom, dateTo, isCompleted };
            }

            function buildUrl() {
                const { categoryId, dateFrom, dateTo, isCompleted } = getFilters();

                const base = '@Url.Action("GetList", "Requests", new { area = "Admin" })';
                const p = new URLSearchParams();

                p.set('isCompleted', isCompleted ? "true" : "false");
                p.set('page', String(state.page));
                p.set('categoryId', categoryId);
                p.set('dateFrom', dateFrom);
                p.set('dateTo', dateTo);

                if (state.term && state.term.trim().length > 0) {
                    p.set('term', state.term.trim());
                }

                return base + '?' + p.toString();
            }

            function setPage(p) {
                state.page = p;
                if (pageInput) pageInput.value = String(p);
            }

            function escapeHtml(s) {
                if (s === null || s === undefined) return '';
                return String(s)
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#039;');
            }

            function renderTable(data) {
                tableBody.innerHTML = '';

                const items = data?.items || [];
                if (items.length === 0) {
                    // У тебе в таблиці 13 колонок (№.. + 2 порожні заголовки)
                    tableBody.innerHTML =
                        `<tr><td colspan="13" class="text-center text-muted">Нічого не знайдено</td></tr>`;
                    return;
                }

                items.forEach(item => {
                    const tr = document.createElement('tr');

                    const audioParts = [];
                    if (item.nameAudio) {
                        audioParts.push(`<label><span><audio controls src="${escapeHtml(item.nameAudio)}"></audio></span></label>`);
                    }
                    if (item.audio) {
                        audioParts.push(`<label><span><audio controls src="${escapeHtml(item.audio)}"></audio></span></label>`);
                    }
                    const audioHtml = audioParts.join('');

                    let actionsHtml = '';
                    if (item.isCompleted) {
                        if (isAdmin === 'true') {
                            actionsHtml = `
                                <form style="display:inline-block;" id="form-${escapeHtml(item.id)}"
                                      action="@Url.Action("Delete", "Requests", new { area = "Admin" })"
                                      method="post" class="d-inline">
                                    <input type="hidden" name="id" value="${escapeHtml(item.id)}" />
                                    <button type="button" class="btn btn-sm btn-danger"
                                            onclick="confirmDelete('${escapeHtml(item.id)}')">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </form>`;
                        }
                    } else {
                        actionsHtml = `
                            <form action="@Url.Action("CompleteRequest", "Requests", new { area = "Admin" })"
                                  method="post">
                                <input type="hidden" name="id" value="${escapeHtml(item.id)}" />
                                <button type="submit" class="btn btn-success">
                                    <i class="fa-solid fa-square-check fa-lg"></i>
                                </button>
                            </form>`;
                    }

                    // ВАЖЛИВО: вирівнюємо колонки під твій <thead>:
                    // № | Номер | Установа | Ім'я | Телефон | Адреса | Категорія | Підкатегорія | Текст | Аудіо | Дата | (show) | (actions)
                    tr.innerHTML = `
                        <th scope="row">${escapeHtml(item.index)}</th>
                        <td><label><span>${escapeHtml(item.requestNumber)}</span></label></td>
                        <td><label><span>${escapeHtml(item.facility)}</span></label></td>
                        <td><label><span>${escapeHtml(item.name)}</span></label></td>
                        <td><label><span>${escapeHtml(item.caller)}</span></label></td>
                        <td><label><span>${escapeHtml(item.address)}</span></label></td>
                        <td><label><span>${escapeHtml(item.category)}</span></label></td>
                        <td><label><span>${escapeHtml(item.subcategory)}</span></label></td>
                        <td><label><span>${escapeHtml(item.text)}</span></label></td>
                        <td>${audioHtml}</td>
                        <td><label><span>${escapeHtml(item.date)}</span></label></td>
                        <td>
                            <a href="@Url.Action("Show", "Requests", new { area = "Admin" })/${escapeHtml(item.id)}">
                                <i class="fa-solid fa-eye fa-lg"></i>
                            </a>
                        </td>
                        <td>${actionsHtml}</td>
                    `;

                    tableBody.appendChild(tr);
                });
            }

            function renderPagination(data) {
                if (!paginationNav) return;

                const term = (state.term || '').trim();
                if (term.length > 0) {
                    paginationNav.style.display = 'none';
                    return;
                }

                const totalPages  = Number(data?.totalPages || 0);
                const currentPage = Number(data?.currentPage || state.page);

                if (!totalPages || totalPages <= 1) {
                    paginationNav.style.display = 'none';
                    return;
                }

                paginationNav.style.display = 'block';

                const ul = paginationNav.querySelector('ul.pagination');
                if (!ul) return;

                ul.innerHTML = '';

                const mkItem = (p, label, active, disabled, ariaLabel) => {
                    const li = document.createElement('li');
                    li.className = `page-item${active ? ' active' : ''}${disabled ? ' disabled' : ''}`;

                    const a = document.createElement('a');
                    a.className = 'page-link';
                    a.href = '#';
                    a.dataset.page = String(p);
                    if (ariaLabel) a.setAttribute('aria-label', ariaLabel);
                    a.innerHTML = label;

                    li.appendChild(a);
                    return li;
                };

                // prev
                ul.appendChild(
                    mkItem(
                        currentPage - 1,
                        '&laquo;',
                        false,
                        currentPage <= 1,
                        'Попередня'
                    )
                );

                for (let i = 1; i <= totalPages; i++) {
                    ul.appendChild(mkItem(i, String(i), i === currentPage, false));
                }

                // next
                ul.appendChild(
                    mkItem(
                        currentPage + 1,
                        '&raquo;',
                        false,
                        currentPage >= totalPages,
                        'Наступна'
                    )
                );

                // делегування кліків
                ul.querySelectorAll('a.page-link').forEach(a => {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        const p = Number(a.dataset.page || currentPage);
                        if (!p || p < 1 || p > totalPages || p === currentPage) return;
                        setPage(p);
                        loadRequests();
                    });
                });
            }

            function loadRequests() {
                // abort previous
                if (lastController) lastController.abort();
                lastController = new AbortController();

                const url = buildUrl();

                fetch(url, { signal: lastController.signal })
                    .then(r => {
                        if (!r.ok) throw new Error('HTTP ' + r.status);
                        return r.json();
                    })
                    .then(data => {
                        // якщо сервер повертає currentPage/totalPages — підхопимо
                        if (data?.currentPage) setPage(Number(data.currentPage));
                        renderTable(data);
                        renderPagination(data);
                    })
                    .catch(err => {
                        if (err.name === 'AbortError') return;
                        console.error('Requests autoload error:', err);
                    });
            }

            // ==== events ====

            // live search (debounce) + на пошук завжди page=1
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    clearTimeout(typingTimer);
                    state.term = (searchInput.value || '');
                    setPage(1);
                    typingTimer = setTimeout(loadRequests, 300);
                });
            }

            // submit фільтрів: не перезавантажуємо сторінку, а вантажимо AJAX-ом
            if (filtersForm) {
                filtersForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    // якщо користувач натиснув "Застосувати" — йдемо на 1 сторінку
                    setPage(1);
                    loadRequests();
                });
            }

            // автоперезавантаження без скидання сторінки
            setInterval(() => {
                // не робимо автозапит поки користувач набирає (щоб не мигало)
                if (typingTimer) return;
                loadRequests();
            }, 10000);

            // перший запуск (щоб одразу працювало після відкриття)
            loadRequests();
        })();
    </script>
}