@using SumyCRM.Areas.Admin.Models
@model DashboardViewModel

<div class="d-flex align-items-center justify-content-between mb-4">
    <div>
        <h2 class="h3 mb-1">Панель моніторингу</h2>
        <p class="text-muted mb-0">Огляд звернень та категорій</p>
    </div>
    <div class="text-end small text-muted">
        <div>Зараз: <span id="currentTime"></span></div>
        <div>Оновлено дані: <span id="lastUpdated"></span></div>
    </div>
</div>

<!-- KPI Картки -->
<div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
        <div class="card shadow-sm border-0 dashboard-card dashboard-card-completed">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="card-label">Активні звернення</div>
                    <div class="card-value text-danger" id="activeCount">@Model.ActiveCount</div>
                </div>
                <div class="card-icon bg-danger-subtle">
                    <i class="fa-solid fa-circle-play"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-4">
        <div class="card shadow-sm border-0 dashboard-card dashboard-card-active">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="card-label">Виконані звернення</div>
                    <div class="card-value text-success" id="completedCount">@Model.CompletedCount</div>
                </div>
                <div class="card-icon bg-success-subtle">
                    <i class="fa-solid fa-circle-check"></i>
                </div>
            </div>
        </div>
    </div>
    @if (User.IsInRole("admin"))
    {
        <div class="col-12 col-md-4">
            <div class="card shadow-sm border-0 dashboard-card dashboard-card-total">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="card-label">Всього звернень</div>
                        <div class="card-value" id="totalCount">@Model.Requests.Count()</div>
                    </div>
                    <div class="card-icon bg-primary-subtle">
                        <i class="fa-solid fa-list-check"></i>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Графіки -->
<div class="row g-4">
    <div class="col-12 col-lg-6">
        <div class="card shadow-sm border-0 dashboard-card">
            <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Статус звернень</h5>
            </div>
            <div class="card-body">
                <canvas id="requestsDonut" style="max-height: 260px;"></canvas>
                <div class="mt-3 d-flex gap-2 flex-wrap">
                </div>
            </div>
        </div>
    </div>

    @if (User.IsInRole("admin"))
    {
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm border-0 dashboard-card">
                <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Звернення за категоріями</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoriesDonut" style="max-height: 260px;"></canvas>

                    @if (Model.CategoryStats.Any())
                    {
                        <ul class="list-unstyled small mt-3 mb-0 category-legend">
                            @foreach (var cat in Model.CategoryStats.OrderByDescending(c => c.Count))
                            {
                                <li class="d-flex justify-content-between">
                                    <span>@cat.Name</span>
                                    <span class="fw-semibold">@cat.Count</span>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted small mt-3 mb-0">Поки що немає даних по категоріях.</p>
                    }
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let requestsChart = null;
        let categoriesChart = null;

        function formatTime(date) {
            return date.toLocaleTimeString('uk-UA', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        setInterval(() => {
            document.getElementById('currentTime').textContent = formatTime(new Date());
        }, 1000);

        async function refreshDashboard() {
            try {
                const url = '@Url.Action("GetDashboardData", "Home", new { area = "Admin" })';
                const response = await fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    console.error('Failed to fetch dashboard data', response.status);
                    return;
                }

                const data = await response.json();

                document.getElementById('lastUpdated').textContent = formatTime(new Date());

                // Обновляем KPI-карточки
                const activeEl = document.querySelector('.dashboard-card-active .card-value');
                const completedEl = document.querySelector('.dashboard-card-completed .card-value');
                const totalEl = document.querySelector('.dashboard-card-total .card-value');

                if (activeEl) activeEl.textContent = data.activeCount;
                if (completedEl) completedEl.textContent = data.completedCount;
                if (totalEl) totalEl.textContent = data.activeCount + data.completedCount;

                // Обновляем donut 1 (Активні / Виконані)
                if (requestsChart) {
                    requestsChart.data.datasets[0].data = [data.activeCount, data.completedCount];
                    requestsChart.update();
                }

                // Обновляем donut 2 (категорії)
                if (categoriesChart && data.categories) {
                    categoriesChart.data.labels = data.categories.map(c => c.name);
                    categoriesChart.data.datasets[0].data = data.categories.map(c => c.count);
                    categoriesChart.update();

                    // Обновляем легенду списком
                    const legend = document.querySelector('.category-legend');
                    if (legend) {
                        legend.innerHTML = '';
                        data.categories.forEach(c => {
                            const li = document.createElement('li');
                            li.className = 'd-flex justify-content-between';
                            li.innerHTML = `<span>${c.name}</span><span class="fw-semibold">${c.count}</span>`;
                            legend.appendChild(li);
                        });
                    }
                }

                // Обновляем время
                const now = new Date();
                const currentTimeEl = document.getElementById('currentTime');
                const lastUpdatedEl = document.getElementById('lastUpdated');

                if (currentTimeEl) currentTimeEl.textContent = formatTime(now);
                if (lastUpdatedEl) lastUpdatedEl.textContent = data.serverTime ?? formatTime(now);

            } catch (err) {
                console.error('Error while refreshing dashboard', err);
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            // ----- Инициализация Donut 1 -----
            const ctx1 = document.getElementById('requestsDonut').getContext('2d');

            const activeCount = @Model.ActiveCount;
            const completedCount = @Model.CompletedCount;

            requestsChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Активні', 'Виконані'],
                    datasets: [{
                        data: [activeCount, completedCount],
                        backgroundColor: [
                            'rgba(244, 67, 54, 0.7)',
                            'rgba(0, 200, 83, 0.7)'
                        ],
                        borderColor: [
                            'rgba(244, 67, 54, 1)',
                            'rgba(0, 200, 83, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    cutout: '60%'
                }
            });

            // ----- Инициализация Donut 2 -----
            const catCanvas = document.getElementById('categoriesDonut');
            if (catCanvas) {
                const ctx2 = catCanvas.getContext('2d');

                const categoryLabels = @Html.Raw(
                System.Text.Json.JsonSerializer.Serialize(
                    Model.CategoryStats.Select(c => c.Name)
                )
            );

                const categoryData = @Html.Raw(
                System.Text.Json.JsonSerializer.Serialize(
                    Model.CategoryStats.Select(c => c.Count)
                )
            );

                categoriesChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryData,
                            backgroundColor: [
                                'rgba(25, 118, 210, 0.7)',
                                'rgba(76, 175, 80, 0.7)',
                                'rgba(255, 193, 7, 0.7)',
                                'rgba(156, 39, 176, 0.7)',
                                'rgba(121, 85, 72, 0.7)',
                                'rgba(3, 169, 244, 0.7)',
                                'rgba(255, 152, 0, 0.7)'
                            ],
                            borderColor: [
                                'rgba(25, 118, 210, 1)',
                                'rgba(76, 175, 80, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(156, 39, 176, 1)',
                                'rgba(121, 85, 72, 1)',
                                'rgba(3, 169, 244, 1)',
                                'rgba(255, 152, 0, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        cutout: '60%'
                    }
                });
            }

            // Первичная установка времени
            const now = new Date();
            const currentTimeEl = document.getElementById('currentTime');
            if (currentTimeEl) currentTimeEl.textContent = formatTime(now);

            // Первый запрос сразу
            refreshDashboard();

            setInterval(refreshDashboard, 10000);
        });
    </script>
}
